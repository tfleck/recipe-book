name: Build and Deploy
on: 
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        
      - name: Install Build Dependencies
        run: |
          wget https://github.com/jgm/pandoc/releases/download/2.13/pandoc-2.13-1-amd64.deb
          sudo dpkg -i pandoc-2.13-1-amd64.deb

      - name: Build 🔧
        run: |
          cd $GITHUB_WORKSPACE
          chmod +x build.sh
          bash build.sh .
          mv _site $HOME/_site
          
      - name: Switch to gh-pages branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages
          
      - name: Clear gh-pages files, and add nojekyll & CNAME files
        run: |
          ls $GITHUB_WORKSPACE
          rm $GITHUB_WORKSPACE/*
          ls $GITHUB_WORKSPACE
          touch .nojekyll
          echo -e "recipes.theofleck.com" > CNAME
          
      - name: Deploy 🚀
        run: |
          cp -r $HOME/_site/* $GITHUB_WORKSPACE
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add -A
          git commit -m "built site"
          git push
